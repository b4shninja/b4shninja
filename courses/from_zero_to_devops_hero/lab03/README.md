# Lab-03: Сеть на Ubuntu — IP, DNS, ping, curl, порты и отладка

## Зачем эта лаба
Так что произошло вот что: сервис «не достучался до базы», сайт не открывается, запросы висят.  
Вот как это работает у джуна: не гадать, а по чек-листу проверить сеть, DNS, порты и логи.  
Эта лаба даёт практику именно этому.

## Что понадобится
- Виртуалка из lab01 (Ubuntu Server LTS).
- Доступ по SSH.
- 30–60 минут времени.
- Пакеты: `traceroute`, `dnsutils` (для `dig`), `netcat-openbsd` (для `nc`).

Установка полезных инструментов:
```bash
sudo apt update
sudo apt install -y traceroute dnsutils netcat-openbsd
```

---

## Что делаем в lab03
1. Проверяем базовую сеть: интерфейсы и маршруты.
2. Проверяем доступ в интернет по IP.
3. Проверяем DNS: резолв доменов.
4. Проверяем HTTP/HTTPS через `curl`.
5. Смотрим открытые порты и поднимаем локальный сервис.
6. Смотрим брандмауэр `ufw` (если включён).
7. Разбираем кейс «не стучится до базы».

Каждый блок: задача → команды → как себя проверить.

---

## 1) Интерфейсы и маршруты

**Задача:** понять, есть ли сетевой интерфейс и маршрут «по умолчанию».

Команды:
```bash
# Интерфейсы и адреса
ip a

# Состояние (UP/DOWN)
ip link

# Маршруты (ищем default via ...)
ip route

# Быстрый список адресов этой ВМ
hostname -I
```

Проверь себя:
- Есть интерфейс с `state UP` и IP (`192.168.x.x` или `10.x.x.x`).
- В `ip route` есть строка `default via ...`.

Если интерфейс DOWN:
```bash
# Пример для eth0
sudo ip link set dev eth0 up
```

---

## 2) Проверка внешней сети по IP

**Задача:** убедиться, что есть связь с внешним миром на уровне IP.

Команды:
```bash
# Пинг до публичного DNS Google (3 пакета)
ping -c 3 8.8.8.8

# Трассировка (путь пакетов)
traceroute 8.8.8.8 || sudo traceroute 8.8.8.8
```

Проверь себя:
- `ping` отвечает без сильных потерь.
- `traceroute` показывает несколько хопов. Если «упёрлось» на первом — проблема в маршруте/NAT.

---

## 3) DNS: резолв имён

**Задача:** понять, почему домены не резолвятся (или резолвятся).

Команды:
```bash
# Сводка по резолверу systemd
resolvectl status

# Короткая проверка
resolvectl query ya.ru

# Подробно через dig (пакет dnsutils)
dig ya.ru A +short
dig google.com AAAA +short
```

Проверь себя:
- Если `ping 8.8.8.8` работает, но `dig ya.ru` пуст — проблема в DNS.
- Посмотри, какой DNS указан в `resolvectl status` (часто 127.0.0.53 — локальный stub).

Если DNS «ломан»:
```bash
# Перезапусти резолвер
sudo systemctl restart systemd-resolved

# Временно прописать публичный DNS для интерфейса (пример: eth0)
sudo resolvectl dns eth0 8.8.8.8 1.1.1.1
sudo resolvectl domain eth0 "~."
```

---

## 4) HTTP/HTTPS через curl

**Задача:** проверить доступность сайтов и увидеть коды ответов.

Команды:
```bash
# HTTP
curl -I http://example.com

# HTTPS (увидишь редирект/код)
curl -I https://example.com

# Детальная отладка TLS/соединения (шумно, но полезно)
curl -vI https://example.com
```

Проверь себя:
- Видишь коды `200/301/302/403/404`.
- Если HTTPS падает — смотри `-v`. Часто виновато время на ВМ (`timedatectl`) или прокси.

---

## 5) Открытые порты и локальные сервисы

**Задача:** увидеть, какие процессы слушают порты, и поднять свой тестовый сервис.

Команды:
```bash
# Открытые порты (Ubuntu использует ss, а не старый netstat)
ss -tulnp | head

# Поднимем простой HTTP-сервер на 9000
python3 -m http.server 9000 &

# Проверим, кто слушает 9000 и что отвечает
ss -tulnp | grep ':9000' || echo '9000 не слушается'
curl -I http://127.0.0.1:9000 | head -n 1
```

Остановить сервер:
```bash
# Найдём PID и завершим
ps aux | grep '[p]ython3 -m http.server 9000'
kill <PID>
```

Проверка `nc` (по желанию):
```bash
# Терминал 1: слушаем TCP 9100 (Ctrl+C, чтобы выйти)
nc -l -p 9100

# Терминал 2: отправим строку
echo 'hello' | nc 127.0.0.1 9100
```

---

## 6) Брандмауэр UFW (если включён)

**Задача:** убедиться, что фаервол не блокирует порты.

Команды:
```bash
sudo ufw status

# Разрешить SSH и наш тестовый порт 9000 (если UFW активен)
sudo ufw allow OpenSSH
sudo ufw allow 9000/tcp
```

Примечание: по умолчанию UFW может быть выключен. Включать ради лабы не обязательно.

---

## 7) Кейс «не стучится до базы» — алгоритм

**Сценарий:** приложение подключается к БД на `10.10.10.50:5432`, но соединения нет.

Алгоритм:
```bash
# 1) Базовая сеть есть?
ping -c 3 10.10.10.50 || echo 'ICMP может быть запрещён — идём дальше'

# 2) Маршрут до сети?
ip route | grep -E 'default|10\.10\.10\.0|10\.10\.10\.50' || echo 'Проверь маршрут/шлюз'

# 3) TCP-порт доступен?
nc -vz 10.10.10.50 5432 || echo 'Порт недоступен: фаервол/ACL/сервер не слушает'

# 4) Если сервер наш — слушает ли он порт?
# На хосте с БД: ss -tulnp | grep ':5432'

# 5) DNS (если подключение по имени)
dig db.internal A +short || echo 'Нет DNS-записи — используй IP или поправь DNS'

# 6) Логи приложения и сервиса БД
# Журнал приложения — зависит от сервиса
# PostgreSQL: /var/log/postgresql/* или journalctl -u postgresql
```

Идея простая: IP → маршрут → порт → DNS → логи.

---

## Итоговый чек-лист lab03

- [ ] Есть `default route` и адрес интерфейса.  
- [ ] `ping 8.8.8.8` отвечает, `traceroute` показывает путь.  
- [ ] `resolvectl status` ок, `dig ya.ru +short` даёт адреса.  
- [ ] `curl -I https://example.com` даёт код ответа.  
- [ ] `ss -tulnp` показывает слушающие порты; поднял локальный сервер на 9000 и получил ответ.  
- [ ] Понимаю алгоритм «не стучится до базы».

---

## Как оформить результат в репозитории

Структура:
```
courses/from_zero_to_devops_hero/lab03/
├─ README.md              # этот файл
├─ notes.md               # что понравилось, что не понял
```

В `README.md` добавь:
- вывод `ip a`, `ip route` (вырежи личные данные, если нужно);
- результат `dig ya.ru +short` и `curl -I https://example.com`;
- строку из `ss -tulnp` про порт 9000;
- пару слов «как бы искал проблему», если база не отвечает.

---

## Типичные проблемы и короткие решения

- **Пингуется IP, но домены не резолвятся.**  
  Проверь `resolvectl status`. Перезапусти: `sudo systemctl restart systemd-resolved`.  
  Временный DNS: `sudo resolvectl dns eth0 8.8.8.8 1.1.1.1`.

- **curl http работает, а https — нет.**  
  Смотри `curl -vI` — часто не совпадает время на ВМ (`timedatectl`), или мешает прокси.

- **Порт не слушается.**  
  Проверь процесс и команду запуска. Смотри `ss -tulnp` и логи сервиса. Проверь UFW.

- **Нет интернета вообще.**  
  В `ip route` нет `default via` — настрой сеть ВМ (NAT/Bridged).

---

## Что дальше
В следующей лабе — `lab04` — соберём мини-сервис: веб + база (локально), и разберём типовые сетевые ошибки пары сервисов.  
В сериале это будет `S01E10`.
