# Lab-05: Первый контакт с Docker — от `docker run` до отладки

## Зачем эта лаба
Контейнеры — это способ упаковать приложение так, чтобы оно запускалось одинаково везде.  
В этой лабе ты руками пройдёшь путь: запустить контейнер → посмотреть, что внутри → найти и починить типовые косяки.

## Что понадобится
- ВМ на Ubuntu (из наших прошлых лаб) с правами `sudo`.
- 30–60 минут.

## Шаг 0. Устанавливаем Docker на Ubuntu
```bash
# Пакет из репозитория Ubuntu — быстро и просто
sudo apt update
sudo apt install -y docker.io

# Запуск и автозапуск
sudo systemctl enable --now docker

# Разрешим запуск без sudo (нужно перелогиниться)
sudo usermod -aG docker "$USER"
# Выйди и зайди заново в терминал (или: exec su - $USER)
```

Проверка версии:
```bash
docker --version
```

## Шаг 1. Тестовый запуск
```bash
# Самый простой «сработало»
docker run --rm hello-world

# Запустим nginx в фоне и пробросим порт 8080 -> 80
docker run -d --name my-nginx -p 8080:80 nginx:latest

# Список контейнеров
docker ps

# Логи
docker logs -n 20 my-nginx

# Быстрый запрос к нашему nginx
curl -I http://127.0.0.1:8080/
```

Ожидаем `200 OK` или `301/302` — главное, что контейнер отвечает.

## Шаг 2. Заглянем внутрь контейнера
```bash
# Посмотрим, что за операционка у нас в контейнере
docker exec -it my-nginx sh -c 'cat /etc/os-release || cat /etc/alpine-release'

# Откроем шелл
docker exec -it my-nginx sh
# внутри: ls -la /etc/nginx && exit
```

## Шаг 3. Сеть и порты (быстрый разбор)
- `-p 8080:80` значит: **хост:контейнер**.
- http://localhost:8080/ - должна отображаться страничка с nginx
- Если страница не открывается, проверь кто слушает порт на хосте:
```bash
ss -tulnp | grep 8080 || echo "никто не слушает 8080 на хосте"
```

## Шаг 4. Типовые проблемы и короткие решения
1) **Образ не скачивается (network/timeout).**  
   Проверь интернет на ВМ: `ping -c 3 8.8.8.8`, `curl https://registry-1.docker.io`.

2) **Порт занят.**  
   `docker run -p 8080:80 ...` падает? Смотри, кто держит 8080:  
   ```bash
   sudo ss -tulnp | grep :8080
   ```
   Либо выбери другой порт хоста, например `-p 8081:80`.

3) **Контейнер сразу умирает.**  
   Посмотри логи: `docker logs <name>`. Часто не хватает переменных/файлов.  
   Узнай, что было командой запуска:
   ```bash
   docker inspect <name> --format '{{.Config.Entrypoint}} {{.Config.Cmd}}'
   ```

4) **Нет прав на сокет docker без sudo.**  
   Ты не перелогинился после `usermod -aG docker`. Выйди и зайди в терминал.

5) **Файрвол/ACL не пускают снаружи.**  
   Локально по `curl 127.0.0.1:8080` работает? Значит, на удалённый доступ влияет UFW/сеть.  
   Разреши порт: `sudo ufw allow 8080/tcp` (если UFW включён).

## Шаг 5. Контейнер → остановка и очистка
```bash
# Остановить и удалить контейнер
docker stop my-nginx
docker rm my-nginx

# Удалить образы и мусор (по желанию)
docker image ls
docker system prune -f
```

## Мини‑челленджи (по желанию)
- Запусти `nginx` с томом и замени главную страницу:
  ```bash
  mkdir -p ~/nginx-www && echo "hello from container" > ~/nginx-www/index.html
  docker run -d --name my-nginx -p 8080:80 -v ~/nginx-www:/usr/share/nginx/html:ro nginx
  curl http://127.0.0.1:8080/
  ```
- Найди, где лежит конфиг nginx внутри контейнера. Подскаска: `/etc/nginx/nginx.conf`.

## Итоговый чек‑лист
- [ ] Docker установлен, `docker --version` работает.  
- [ ] `hello-world` отработал без ошибок.  
- [ ] Контейнер `nginx` отвечает на `http://127.0.0.1:8080`.  
- [ ] Можешь зайти внутрь контейнера через `docker exec -it`.  
- [ ] Понимаешь базовые причины «не работает» (порт/сеть/команда/права).

## Что дальше
В **S02E02** напишем свой `Dockerfile`, соберём образ и разберёмся, почему он бывает «толстым», и как сделать его меньше.
